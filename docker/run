#!/bin/bash

# Usage info
show_help() {
    cat << EOF
Usage: ${0##*/} [-h] [-p PORT] [-r]
Run datatracker in dev containers using docker-compose.

    -h          display this help and exit
    -p PORT     use custom HTTP port for datatracker
    -r          force rebuild the app container

EOF
}

CUSTOM_PORT=8000
FORCE_REBUILD=0

while getopts "hp:r" opt; do
    case $opt in
        h)
            show_help
            exit 0
            ;;
        p)  
            CUSTOM_PORT=$OPTARG
            echo "Using custom port $CUSTOM_PORT..."
            ;;
        r)
            FORCE_REBUILD=1
            echo "Will force rebuild the app container..."
            ;;
        *)
            CUSTOM_PORT=8000
            echo "Using port 8000..."
            ;;
    esac
done

cp docker-compose.extend.yml docker-compose.extend-custom.yml
sed -i -r -e "s/CUSTOM_PORT/$CUSTOM_PORT/" docker-compose.extend-custom.yml
cd ..
if [ $FORCE_REBUILD ==  1 ]; then
    docker-compose -f docker-compose.yml -f docker/docker-compose.extend-custom.yml down
    docker-compose -f docker-compose.yml -f docker/docker-compose.extend-custom.yml rm -f
    docker-compose -f docker-compose.yml -f docker/docker-compose.extend-custom.yml build --no-cache --pull --build-arg USER_UID=$(id -u) --build-arg USER_GID=$(id -g)
    docker-compose -f docker-compose.yml -f docker/docker-compose.extend-custom.yml up -d --force-recreate
else
    docker-compose -f docker-compose.yml -f docker/docker-compose.extend-custom.yml up -d
fi
echo "Database exposed on port:"
docker-compose port db 3306
docker-compose exec app /bin/sh /docker-init.sh
docker-compose stop
cd docker
rm -f docker-compose.extend-custom.yml
